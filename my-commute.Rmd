---
title: "My Commute"
author: "Nick Cotter"
date: "21st December 2018"
output:
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r libraries, message=F, warning=F}
require(dplyr)
require(lubridate)
require(data.table)
require(ggplot2)
require(stringr)
```

## Summary

I wished to determine the best time to set off for work, in particular what departure time results in the shortest average journey time. To this end I gathered timing data using my iPhone and IFTTT (specifically the latter's Location and Google Sheets services).

The data is recorded at 3 points:

* when I leave home 
* when I arrive at the express way
* when I arrive at my place of work

The journey is some 35 miles, most of which are on a dual carriageway and the last 5 of which are in the city where I work. The express way marks the boundary of the city. There are often roadworks in the city which cause large traffic jams; there are rarely accidents on the dual carriage way which cause huge delays.

## Load The Data

I have collected several batches of the spreadsheets generated by this process, starting in 2017. These are converted into CSV files, zipped up and placed in the data directory.

Let's unpack them into their individual files - these will be called

* start.csv
* expressway.csv
* end.csv

```{r loadthedata}
unzip("data/export-150817.zip", exdir="unpacked")
unzip("data/export-171017.zip", exdir="unpacked")
unzip("data/export-300118.zip", exdir="unpacked")
unzip("data/export-130718.zip", exdir="unpacked")
unzip("data/export-211218.zip", exdir="unpacked")
```

## Preprocess The Data

Each file has only one important column, the first, which is the date and time of the event, eg "December 05, 2018 at 05:10PM".

We now combine all the files into a single tidy dataset where each row is a journey and the columns are start, expressway and end times. We will also remove any outliers (these include errors in the IFTTT process and trips where I leave home but do not head into work - weekends for example).

```{r prerocessthedata}

# function to extract date & time from raw data
readdata <- function(f) {
  fread(f, select=c(1), col.names=c("datetime"))
}

# create data frames for start, express way and end points reached
start <- rbindlist(lapply(list.files(path="unpacked", pattern="start.csv", full.names = TRUE, recursive = TRUE), readdata))
expressway <- rbindlist(lapply(list.files(path="unpacked", pattern="expressway.csv", full.names = TRUE, recursive = TRUE), readdata))
end <- rbindlist(lapply(list.files(path="unpacked", pattern="end", full.names = TRUE, recursive = TRUE), readdata))

# column names
colnames(start) <- c("RawDateTime")
colnames(expressway) <- c("RawDateTime")
colnames(end) <- c("RawDateTime")

# convert date into date and time
start$Date <- as.Date(start$RawDateTime, format("%b %d, %Y at %H:%M%p"))
start$DateTime <- as.POSIXct(start$RawDateTime, format="%b %d, %Y at %H:%M%p")
start <- subset(start, select=c(2:3))

expressway$Date <- as.Date(expressway$RawDateTime, format("%b %d, %Y at %H:%M%p"))
expressway$DateTime <- as.POSIXct(expressway$RawDateTime, format="%b %d, %Y at %H:%M%p")
expressway <- subset(expressway, select=c(2:3))

end$Date <- as.Date(end$RawDateTime, format("%b %d, %Y at %H:%M%p"))
end$DateTime <- as.POSIXct(end$RawDateTime, format="%b %d, %Y at %H:%M%p")
end <- subset(end, select=c(2:3))

# combine into one tidy data set where each row is a journey

# join together by date
start_to_expressway <- inner_join(start, expressway, by=c("Date" = "Date"), suffix=c(".start", ".xway"))
journeys <- inner_join(start_to_expressway, end, by=c("Date" = "Date"))
colnames(journeys) <- c("Date", "Start", "ExpressWay", "End")

# remove outliers (all should be between 6am and 10am) and bad readings
journeys <- subset(journeys, am(journeys$Start) & hour(journeys$Start) > 6 & hour(journeys$Start) < 9 & hour(journeys$End) < 10 & am(journeys$End))
journeys <- subset(journeys, journeys$Start < journeys$End)
journeys <- subset(journeys, journeys$ExpressWay < journeys$End)
journeys <- subset(journeys, journeys$ExpressWay > journeys$Start)

# add segment travel times
journeys$StartToExpressWay <- difftime(journeys$ExpressWay, journeys$Start)
journeys$ExpressWayToEnd <- difftime(journeys$End, journeys$ExpressWay)
journeys$Total <- difftime(journeys$End, journeys$Start)

# remove journeys longer than 90 minutes (these usually involve errands on the way to work)
journeys <- subset(journeys, journeys$Total <= 90)

# add start time for convenience
journeys$StartTime <- as.numeric(journeys$Start-trunc(journeys$Start, "days"))

# add day of week as ordered factor
journeys$dow <- factor(weekdays(journeys$Date), levels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

head(journeys)

```

```{r time-formatting}
format_time <- function(time) {
  hours <- floor(time)
  minutes <- (time - floor(time)) * 60
  minutes <- floor(minutes)
  minutes <- str_pad(minutes, 2, side="left", pad="0")
  formatted <- paste(hours,minutes,sep=":")
  return(formatted)
}

```


## Plots

# Total Journey Time Variation

Let's look at how total journey time varies.

```{r totalvariation}
ggplot(journeys, aes(x = as.numeric(Total))) + geom_histogram(binwidth=1, fill="darkblue") + ylab("# Journeys") + xlab("Total Journey Time (minutes)")
```

We see that journeys of 45-50 minutes are most common.


# Total Journey Time By Start Time

How does total journey time vary by start time?

```{r totalbystart}
ggplot(journeys, aes(StartTime, Total)) + geom_point() + geom_smooth(method="lm") + scale_y_continuous(expand = c(0,0)) + scale_x_continuous(labels=format_time) + ylab("Total Duration (minutes)") + xlab("Start Time")
```

The slight slope suggests that leaving later means taking less time. Possible explanations include:

* leaving later means hitting the city later, and possibly missing the traffic jams there more often
* leaving later means driving faster on the dual carriageway to make up for lost time

Also, note that there are rather more data points in the latter end of the graph - we need more data at the 7:30 and 8:00 regions.

# Total Journey Time By Time Spend On Dual Carriage Way

Let's see if the speed on the dual carriage way is a significant factor. The time spent there is equal to express way time minus the start time.

```{r totalbydualcarriageway}
ggplot(journeys, aes(as.double(StartToExpressWay, units='secs')*100/as.double(Total, units='secs'), StartToExpressWay)) + geom_point() + geom_smooth(method="lm") + xlab("% Time On Dual Carriageway") + ylab("Time Spent On Dual Carriageway")
```


# Total Journey Time By Start Time For Each Day Of The Week

```{r totalbystartdow}
ggplot(journeys, aes(StartTime, Total)) + geom_point() + geom_smooth(method="lm") + facet_grid(.~dow) + scale_y_continuous(expand = c(0,0)) + scale_x_continuous(labels=format_time) + ylab("Total Duration (minutes)") + xlab("Start Time")
```

# Time Taken from Express Way to Work by Start Time

```{r expresswaybystart}
ggplot(journeys, aes(StartTime, ExpressWayToEnd)) + geom_point() + geom_smooth(method="lm") + scale_y_continuous(expand = c(0,0)) + scale_x_continuous(labels=format_time) + ylab("Duration (minutes)") + xlab("Start Time")
```
